<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gimbal Tracking Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --border: #e2e8f0;
            --text: #0f172a;
            --text-muted: #64748b;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-yellow: #f59e0b;
            --accent-red: #ef4444;
            --accent-purple: #8b5cf6;
            --accent-cyan: #06b6d4;
            --glow-blue: rgba(59, 130, 246, 0.1);
            --glow-green: rgba(16, 185, 129, 0.1);
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text);
            min-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            padding: 16px 32px;
            display: flex;
            align-items: center;
            gap: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }

        .logo-container {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
        }

        .logo-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .header-info {
            flex: 1;
        }

        .header-info h1 {
            font-size: 20px;
            font-weight: 700;
            color: var(--text);
        }

        .header-info p {
            font-size: 13px;
            color: var(--text-muted);
        }

        .status-pill {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid var(--accent-green);
            border-radius: 50px;
            font-size: 13px;
            font-weight: 600;
            color: var(--accent-green);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent-green);
            box-shadow: 0 0 12px var(--glow-green);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.2);
                opacity: 0.7;
            }
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 24px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            position: relative;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -1px;
            margin-bottom: 4px;
        }

        .metric-value.blue {
            color: var(--accent-blue);
        }

        .metric-value.green {
            color: var(--accent-green);
        }

        .metric-value.yellow {
            color: var(--accent-yellow);
        }

        .metric-value.red {
            color: var(--accent-red);
        }

        .metric-value.cyan {
            color: var(--accent-cyan);
        }

        .metric-value.purple {
            color: var(--accent-purple);
        }

        .metric-label {
            font-size: 13px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .charts-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .logs-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text);
        }

        .card-body {
            padding: 16px 20px;
        }

        .chart-wrapper {
            position: relative;
            height: 200px;
        }

        .log-panel {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            background: #f1f5f9;
            border-radius: 8px;
            padding: 12px;
        }

        .log-entry {
            padding: 6px 10px;
            margin-bottom: 6px;
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text);
        }

        .log-time {
            color: var(--text-muted);
            font-size: 10px;
            white-space: nowrap;
        }

        .log-badge {
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .log-badge.tx {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
        }

        .log-badge.rx {
            background: linear-gradient(135deg, var(--accent-green), var(--accent-cyan));
            color: white;
        }

        .log-message {
            color: var(--text);
            flex: 1;
            word-break: break-all;
        }

        .error-entry {
            padding: 10px 14px;
            margin-bottom: 8px;
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid var(--accent-red);
            border-radius: 8px;
        }

        .error-time {
            color: var(--accent-red);
            font-size: 10px;
            font-weight: 600;
        }

        .error-message {
            color: var(--text);
            margin-top: 4px;
            font-size: 11px;
        }

        .no-errors {
            color: var(--accent-green);
            text-align: center;
            padding: 40px 20px;
            font-size: 13px;
        }

        .no-errors span {
            display: block;
            font-size: 28px;
            margin-bottom: 10px;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        @media (max-width: 1400px) {
            .metrics-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .charts-section,
            .logs-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="logo-container">
            <img src="/static/logo.webp" alt="Logo" onerror="this.parentElement.innerHTML='ðŸŽ¯'">
        </div>
        <div class="header-info">
            <h1>Gimbal Tracking System</h1>
            <p>Real-time Monitoring Dashboard â€¢ v2.0</p>
        </div>
        <div class="status-pill">
            <span class="status-dot"></span>
            <span>LIVE</span>
        </div>
    </header>

    <div class="container">
        <!-- Metrics -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value cyan" id="fps">--</div>
                <div class="metric-label">FPS</div>
            </div>
            <div class="metric-card">
                <div class="metric-value yellow" id="inference">--</div>
                <div class="metric-label">Inference</div>
            </div>
            <div class="metric-card">
                <div class="metric-value blue" id="pan">--</div>
                <div class="metric-label">Pan Angle</div>
            </div>
            <div class="metric-card">
                <div class="metric-value purple" id="tilt">--</div>
                <div class="metric-label">Tilt Angle</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" style="color: #f97316;" id="roll">--</div>
                <div class="metric-label">Roll Angle (ESP32)</div>
            </div>
            <div class="metric-card">
                <div class="metric-value text-muted" id="tracking-mode">OFF</div>
                <div class="metric-label">Tracking Mode</div>
            </div>
            <div class="metric-card">
                <div class="metric-value green" id="ble">--</div>
                <div class="metric-label">BLE Status</div>
            </div>
        </div>

        <!-- Charts: 3 columns -->
        <div class="charts-section">
            <!-- PAN Chart -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Pan Angle</span>
                </div>
                <div class="card-body">
                    <div class="chart-wrapper">
                        <canvas id="panChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- TILT Chart -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Tilt Angle</span>
                </div>
                <div class="card-body">
                    <div class="chart-wrapper">
                        <canvas id="tiltChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- FPS Chart -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">FPS History</span>
                </div>
                <div class="card-body">
                    <div class="chart-wrapper">
                        <canvas id="fpsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- ROLL Chart (NEW) -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Roll Angle (ESP32 IMU)</span>
                </div>
                <div class="card-body">
                    <div class="chart-wrapper">
                        <canvas id="rollChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs: 3 columns -->
        <div class="logs-section">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">App â†’ ESP32</span>
                </div>
                <div class="card-body">
                    <div class="log-panel" id="tx-log">
                        <div style="text-align:center; color: var(--text-muted); padding: 40px;">Waiting for data...
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title">ESP32 â†’ App</span>
                </div>
                <div class="card-body">
                    <div class="log-panel" id="rx-log">
                        <div style="text-align:center; color: var(--text-muted); padding: 40px;">Waiting for data...
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const chartOptions = {
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
            interaction: { intersect: false, mode: 'index' },
            plugins: {
                legend: { labels: { color: '#64748b', font: { family: 'Inter', size: 11 }, boxWidth: 12, usePointStyle: true } }
            },
            scales: {
                x: { grid: { color: '#f1f5f9' }, ticks: { color: '#64748b', maxTicksLimit: 6, font: { size: 10 } } },
                y: { grid: { color: '#f1f5f9' }, ticks: { color: '#64748b', font: { size: 10 } } }
            }
        };

        // PAN Chart (GÃ³c + Dao Ä‘á»™ng)
        const panChart = new Chart(document.getElementById('panChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'Pan (Â°)', data: [], borderColor: '#6366f1', backgroundColor: 'rgba(99,102,241,0.1)', borderWidth: 2, tension: 0.3, pointRadius: 0, fill: true, yAxisID: 'y' },
                    { label: 'Î” Dao Ä‘á»™ng', data: [], borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,0.1)', borderWidth: 2, tension: 0.3, pointRadius: 0, fill: true, yAxisID: 'y1' }
                ]
            },
            options: {
                ...chartOptions,
                scales: {
                    x: chartOptions.scales.x,
                    y: { type: 'linear', position: 'left', min: -45, max: 45, grid: { color: '#f1f5f9' }, ticks: { color: '#64748b', font: { size: 10 } }, title: { display: true, text: 'Degree (Â°)', color: '#64748b', font: { size: 11 } } },
                    y1: { type: 'linear', position: 'right', min: 0, max: 15, grid: { drawOnChartArea: false }, ticks: { color: '#f59e0b', font: { size: 10 } }, title: { display: true, text: 'Delta', color: '#f59e0b', font: { size: 11 } } }
                }
            }
        });

        // TILT Chart (GÃ³c + Dao Ä‘á»™ng)
        const tiltChart = new Chart(document.getElementById('tiltChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'Tilt (Â°)', data: [], borderColor: '#8b5cf6', backgroundColor: 'rgba(139,92,246,0.1)', borderWidth: 2, tension: 0.3, pointRadius: 0, fill: true, yAxisID: 'y' },
                    { label: 'Î” Dao Ä‘á»™ng', data: [], borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', borderWidth: 2, tension: 0.3, pointRadius: 0, fill: true, yAxisID: 'y1' }
                ]
            },
            options: {
                ...chartOptions,
                scales: {
                    x: chartOptions.scales.x,
                    y: { type: 'linear', position: 'left', min: -45, max: 45, grid: { color: '#f1f5f9' }, ticks: { color: '#64748b', font: { size: 10 } }, title: { display: true, text: 'Degree (Â°)', color: '#64748b', font: { size: 11 } } },
                    y1: { type: 'linear', position: 'right', min: 0, max: 15, grid: { drawOnChartArea: false }, ticks: { color: '#10b981', font: { size: 10 } }, title: { display: true, text: 'Delta', color: '#10b981', font: { size: 11 } } }
                }
            }
        });

        // FPS Chart
        const fpsChart = new Chart(document.getElementById('fpsChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'FPS', data: [], borderColor: '#06b6d4', backgroundColor: 'rgba(6,182,212,0.15)', borderWidth: 2, tension: 0.3, pointRadius: 0, fill: true }
                ]
            },
            options: {
                ...chartOptions,
                scales: {
                    x: chartOptions.scales.x,
                    y: { min: 0, max: 60, grid: { color: '#f1f5f9' }, ticks: { color: '#64748b', font: { size: 10 } }, title: { display: true, text: 'FPS', color: '#64748b', font: { size: 11 } } }
                }
            }
        });

        // ROLL Chart (NEW - ESP32 IMU)
        const rollChart = new Chart(document.getElementById('rollChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'Roll (Â°)', data: [], borderColor: '#f97316', backgroundColor: 'rgba(249,115,22,0.1)', borderWidth: 2, tension: 0.3, pointRadius: 0, fill: true, yAxisID: 'y' },
                    { label: 'Î” Dao Ä‘á»™ng', data: [], borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.1)', borderWidth: 2, tension: 0.3, pointRadius: 0, fill: true, yAxisID: 'y1' }
                ]
            },
            options: {
                ...chartOptions,
                scales: {
                    x: chartOptions.scales.x,
                    y: { type: 'linear', position: 'left', min: -180, max: 180, grid: { color: '#f1f5f9' }, ticks: { color: '#64748b', font: { size: 10 } }, title: { display: true, text: 'Degree (Â°)', color: '#64748b', font: { size: 11 } } },
                    y1: { type: 'linear', position: 'right', min: 0, max: 30, grid: { drawOnChartArea: false }, ticks: { color: '#22c55e', font: { size: 10 } }, title: { display: true, text: 'Delta', color: '#22c55e', font: { size: 11 } } }
                }
            }
        });

        let prevPan = 0, prevTilt = 0, prevRoll = 0, txLogs = [], rxLogs = [];
        let lastRxTime = 0;

        function addTxLog(data) {
            const now = new Date().toLocaleTimeString();
            txLogs.unshift({ time: now, data: data });
            if (txLogs.length > 30) txLogs.pop();
            document.getElementById('tx-log').innerHTML = txLogs.map(l =>
                '<div class="log-entry"><span class="log-time">' + l.time + '</span><span class="log-badge tx">TX</span><span class="log-message">' + l.data + '</span></div>'
            ).join('');
        }

        function addRxLog(data) {
            const now = new Date().toLocaleTimeString();
            rxLogs.unshift({ time: now, data: data });
            if (rxLogs.length > 30) rxLogs.pop();
            document.getElementById('rx-log').innerHTML = rxLogs.map(l =>
                '<div class="log-entry"><span class="log-time">' + l.time + '</span><span class="log-badge rx">RX</span><span class="log-message">' + l.data + '</span></div>'
            ).join('');
        }

        function updateMetrics() {
            fetch('/api/latest').then(r => r.json()).then(data => {
                if (!data || Object.keys(data).length === 0) return;

                const fps = data.fps || 0;
                const pan = data.panAngle || 0;
                const tilt = data.tiltAngle || 0;
                const roll = data.rollAngle || 0;  // [NEW] Roll from ESP32

                document.getElementById('fps').innerText = fps ? fps.toFixed(1) : '--';
                document.getElementById('inference').innerText = data.inferenceTime ? data.inferenceTime + 'ms' : '--';
                document.getElementById('pan').innerText = pan ? pan.toFixed(1) + 'Â°' : '--';
                document.getElementById('tilt').innerText = tilt ? tilt.toFixed(1) + 'Â°' : '--';
                document.getElementById('roll').innerText = roll ? roll.toFixed(1) + 'Â°' : '--';  // [NEW] Roll display

                const trackingEl = document.getElementById('tracking-mode');
                trackingEl.innerText = data.isTracking ? 'ON' : 'OFF';
                trackingEl.className = 'metric-value ' + (data.isTracking ? 'blue' : 'text-muted');

                const bleEl = document.getElementById('ble');
                bleEl.innerText = data.bleConnected ? 'OK' : 'OFF';
                bleEl.className = 'metric-value ' + (data.bleConnected ? 'green' : 'red');

                const now = new Date().toLocaleTimeString();

                // PAN chart
                panChart.data.labels.push(now);
                panChart.data.datasets[0].data.push(pan);
                panChart.data.datasets[1].data.push(Math.abs(pan - prevPan));

                // TILT chart
                tiltChart.data.labels.push(now);
                tiltChart.data.datasets[0].data.push(tilt);
                tiltChart.data.datasets[1].data.push(Math.abs(tilt - prevTilt));

                // FPS chart
                fpsChart.data.labels.push(now);
                fpsChart.data.datasets[0].data.push(fps);

                // ROLL chart (NEW)
                rollChart.data.labels.push(now);
                rollChart.data.datasets[0].data.push(roll);
                rollChart.data.datasets[1].data.push(Math.abs(roll - prevRoll));

                prevPan = pan; prevTilt = tilt; prevRoll = roll;

                // Limit data points
                const MAX_POINTS = 60;
                [panChart, tiltChart, fpsChart, rollChart].forEach(chart => {
                    if (chart.data.labels.length > MAX_POINTS) {
                        chart.data.labels.shift();
                        chart.data.datasets.forEach(d => d.data.shift());
                    }
                    chart.update();
                });

                if (pan !== 0 || tilt !== 0) {
                    addTxLog('{ {[ax]:' + pan.toFixed(0) + ';[ay]:' + tilt.toFixed(0) + '} }');
                }

                // Check for new RX data
                if (data.lastReceivedDataTime && data.lastReceivedDataTime > lastRxTime && data.lastReceivedData) {
                    addRxLog(data.lastReceivedData);
                    lastRxTime = data.lastReceivedDataTime;
                }
            });
        }

        setInterval(updateMetrics, 200);
        updateMetrics();
    </script>
</body>

</html>